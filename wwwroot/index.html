<!DOCTYPE html>
<html>
<head>
<title>Quiz Game</title>
<script type="text/javascript">

var xid = "";
var accesscode = "";
var PollIntervalID;
var state = "";

function leaveGame() {
	acode.innerHTML = "";
	game.innerHTML = ""; 
	xid = "";
	accesscode = "";
	clearInterval(PollIntervalID);
	alert("Left.");
}

function startGame() {
	var xhr = new XMLHttpRequest();
	var url = "/start";

	xhr.open("POST", url, true);
	xhr.setRequestHeader("Content-Type", "application/json");
	xhr.onreadystatechange = function () {
    	if (xhr.readyState === 4 && xhr.status === 200) {}
	};

   var data = JSON.stringify({ "AccessCode": accesscode, "Xid": xid }); 
   xhr.send(data);
}

function newGame() {

	var xhr = new XMLHttpRequest();
	var url = "/new";

	xhr.open("POST", url, true);
	xhr.setRequestHeader("Content-Type", "application/json");
	xhr.onreadystatechange = function () {
    	if (xhr.readyState === 4 && xhr.status === 200) {
        	var json = JSON.parse(xhr.responseText);
        	accesscode = json.Payload.AccessCode;
        	acode.innerHTML = accesscode;
        	game.innerHTML = json.Html; 
    	}
	};

   var data = JSON.stringify({}); 
   xhr.send(data);
}

function pollGame() {
	var xhr = new XMLHttpRequest();
	var url = "/poll";

	xhr.open("POST", url, true);
	xhr.setRequestHeader("Content-Type", "application/json");
	xhr.onreadystatechange = function () {
    	if (xhr.readyState === 4 && xhr.status === 200) {
        	var json = JSON.parse(xhr.responseText);
        	if (json.State != state) {
        		game.innerHTML = json.GameHtml;
        		state = json.State;
        	}
        	scores.innerHTML = json.ScoreHtml; 
        	timer.innerHTML = json.TimerHtml;
    	}
	};

	var data = JSON.stringify({ "AccessCode": accesscode, "Xid": xid }); 
   	xhr.send(data);
}

function joinGame() { 

    let name = document.querySelector('#name'); 
    let acode = document.querySelector('#accesscode');

	var xhr = new XMLHttpRequest();
	var url = "/join";

	xhr.open("POST", url, true);
	xhr.setRequestHeader("Content-Type", "application/json");
	xhr.onreadystatechange = function () {
    	if (xhr.readyState === 4 && xhr.status === 200) {
        	var json = JSON.parse(xhr.responseText);
        	xid = json.Payload.Xid;
        	game.innerHTML = json.Html; 
        	if (PollIntervalID == null) {
        		PollIntervalID = setInterval(pollGame, 2000)
        	}
    	}
	};

	if (name != null && accesscode != null) {
    	var data = JSON.stringify({ "AccessCode": acode.value, "Name": name.value }); 
    } else {
    	var data = JSON.stringify({});
    }

	xhr.send(data);
}
</script>
</head>
<body>
<h1>Quiz game!</h1>
<h5>version 5</h5>
<p class="topmenu">
	<a href="javascript:newGame();">New Game</a>&nbsp;&nbsp;&nbsp;
	<a href="javascript:joinGame();">Join Game</a>&nbsp;&nbsp;&nbsp;
    <a href="javascript:scoreGame();">Score Game</a>&nbsp;&nbsp;&nbsp;
    <a href="javascript:pollGame();">Poll Game</a>&nbsp;&nbsp;&nbsp;
	<a href="javascript:leaveGame();">Leave Game</a>
</p>
<h3>Players</h3>
<div class="scoresview" id="scores"></div>
<h3>Time</h3>
<div class="timerview" id="timer"></div>
<h3>Access Code</h3>
<div class="acodeview" id="acode"></div>
<hr />
<div class="gameview" id="game"></div>    
</body>
</html>