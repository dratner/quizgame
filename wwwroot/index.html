<!DOCTYPE html>
<html>
<head>
<title>Quiz Game</title>
<script type="text/javascript">

var xid = "";
var accesscode = "";
var pollIntervalID;
var state = "";

function leaveGame() {
	acode.innerHTML = "";
	game.innerHTML = ""; 
	scores.innerHTML = "";
	timer.innerHTML = "";
	xid = "";
	accesscode = "";
	clearInterval(pollIntervalID);
}

function sendReq(url, data, doneFunc) {
	var xhr = new XMLHttpRequest();
	xhr.open("POST", url, true);
	xhr.setRequestHeader("Content-Type", "application/json");
	xhr.onreadystatechange = function () {
    	if (xhr.readyState === 4 && xhr.status === 200) {
        	var json = JSON.parse(xhr.responseText);
        	if (state != json.State) {
        	    state = json.State;
        	    game.innerHTML = json.GameHtml;
        	}
        	scores.innerHTML = json.ScoreHtml;
        	timer.innerHTML = json.TimerHtml;
        	doneFunc(json.Payload);
    	}
	};

   xhr.send(data);
}

function endGame() {
	alert("end");
	doneFunc = function(data) { 
		alert("Done!");
		leaveGame(); 
	}
	sendReq("/req",JSON.stringify({ "AccessCode": accesscode, "Xid": xid, "RequestType": "end" }),doneFunc);
}

function newGame() {
	doneFunc = function(data) { 
		accesscode = data; 
		acode.innerHTML = accesscode;
	}
	sendReq("/new",JSON.stringify({}),doneFunc);
}

function joinGame() {
	
	let name = document.querySelector('#name'); 
    let acode = document.querySelector('#accesscode');
	
	if (name == null || accesscode == null) {
		game.innerHTML = `
			<input type="text" id="name" placeholder="Your name">
			<input type="text" id="accesscode" placeholder="Access code">
			<button onclick="joinGame()">Join Game!</button>
			`;
		return;
	} 

	doneFunc = function(data) {
		xid = data;
        if (pollIntervalID != null) {
        	clearInterval(pollIntervalID);
        }	
        pollIntervalID = setInterval(pollGame, 2000);

        game.innerHTML = `
        	<p>Is everyone here?</p>
			<button onclick="startGame()">Start Game!</button> 
			`;
	}

	sendReq("/req",JSON.stringify({ "AccessCode": acode.value, "Payload": name.value, "RequestType": "join" }),doneFunc);
}

function pollGame() {
	doneFunc = function(data) {};
	sendReq("/req",JSON.stringify({ "AccessCode": accesscode, "Xid": xid, "RequestType": "poll" }),doneFunc);
}

function startGame() {
	doneFunc = function(data) {};
	sendReq("/req",JSON.stringify({ "AccessCode": accesscode, "Payload": xid, "RequestType": "start" }),doneFunc);
}

</script>
</head>
<body>
<h1>Quiz game!</h1>
<h5>version 6</h5>
<p class="topmenu">
	<a href="javascript:newGame();">New Game</a>&nbsp;&nbsp;&nbsp;
	<a href="javascript:joinGame();">Join Game</a>&nbsp;&nbsp;&nbsp;
	<a href="javascript:leaveGame();">Leave Game</a>&nbsp;&nbsp;&nbsp;
	<a href="javascript:endGame();">End For All</a>
</p>
<h3>Players</h3>
<div class="scoresview" id="scores"></div>
<h3>Time</h3>
<div class="timerview" id="timer"></div>
<h3>Access Code</h3>
<div class="acodeview" id="acode"></div>
<hr />
<div class="gameview" id="game"></div>    
</body>
</html>