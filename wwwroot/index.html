<!DOCTYPE html>
<html>
<head>
<title>Famous Firsts</title>
<script type="text/javascript">

var token = "";
var accesscode = "";
var pollIntervalID;
var state = "";

function leaveGame() {
	acode.innerHTML = "";
	game.innerHTML = ""; 
	scores.innerHTML = "";
	timer.innerHTML = "";
	token = "";
	accesscode = "";
	clearInterval(pollIntervalID);
}

function sendReq(url, data, doneFunc) {
	var xhr = new XMLHttpRequest();
	xhr.open("POST", url, true);
	xhr.setRequestHeader("Content-Type", "application/json");
	xhr.onreadystatechange = function () {
    	if (xhr.readyState === 4 && xhr.status === 200) {
        	var json = JSON.parse(xhr.responseText);
        	if (state != json.State) {
        	    state = json.State;
        	    game.innerHTML = json.GameHtml;
        	}
        	scores.innerHTML = json.ScoreHtml;
        	timer.innerHTML = json.TimerHtml;
        	doneFunc(json.Payload);
    	}
    	if (xhr.readyState === 4 && xhr.status === 422) {
        	leaveGame();
    	}
	};

   xhr.send(data);
}

function endGame() {
	doneFunc = function(data) { 
		leaveGame(); 
	}
	sendReq("/req",JSON.stringify({ "AccessCode": accesscode, "Token": token, "RequestType": "end" }),doneFunc);
}

function newGame() {
	doneFunc = function(data) { 
		accesscode = data; 
		acode.innerHTML = accesscode;
	}
	sendReq("/new",JSON.stringify({}),doneFunc);
}

function joinGame() {
	
	let name = document.querySelector('#name'); 
    let code = document.querySelector('#accesscode');


	if (name == null || accesscode == null) {
		game.innerHTML = `
			<input type="text" id="name" placeholder="Your name">
			<input type="text" id="accesscode" placeholder="Access code">
			<button onclick="joinGame()">Join Game!</button>
			`;
		return;
	} else {
		    accesscode = code.value
		    acode.innerHTML = accesscode
	}

	doneFunc = function(data) {
		token = data;
        if (pollIntervalID != null) {
        	clearInterval(pollIntervalID);
        }	
        pollIntervalID = setInterval(pollGame, 2000);

        game.innerHTML = `
        	<p>Is everyone here?</p>
			<button onclick="startGame()">Start Game!</button> 
			`;
	}

	sendReq("/req",JSON.stringify({ "AccessCode": accesscode, "Payload": name.value, "RequestType": "join" }),doneFunc);
}

function pollGame() {
	doneFunc = function(data) {};
	sendReq("/req",JSON.stringify({ "AccessCode": accesscode, "Token": token, "RequestType": "poll" }),doneFunc);
}

function startGame() {
	doneFunc = function(data) {};
	sendReq("/req",JSON.stringify({ "AccessCode": accesscode, "Payload": token, "RequestType": "start" }),doneFunc);
}

function submitGame() {
	submission = document.getElementById("submission").value

	doneFunc = function(data) {};
	sendReq("/req",JSON.stringify({ "AccessCode": accesscode, "Token": token, "Payload": submission, "RequestType": "submit" }),doneFunc);
}

function answerGame() {
	answer = document.querySelector('input[name="answer"]:checked').value

	doneFunc = function(data) {};
	sendReq("/req",JSON.stringify({ "AccessCode": accesscode, "Token": token, "Payload": answer, "RequestType": "answer" }),doneFunc);
}

function nextGame() {
	doneFunc = function(data) {};
	sendReq("/req",JSON.stringify({ "AccessCode": accesscode, "Token": token, "Payload": "", "RequestType": "next" }),doneFunc);
}

function rules() {
	alert(`This is a literary quiz game. In each round, the players will be presented with the summary of a book, well known or otherwise. Each player will then write the first sentence of that book as she might imagine it to be. Once each player has submitted a suggestion, all the players will be able to guess the real first sentence from a list including all the suggested sentences and, of course, the real one. You get a point for getting the real one and a point for fooling another player. Play continues until all the books have been written and then the person with the highest score wins. Enjoy!`)
}

</script>
</head>
<body>
<h1>Famous Firsts</h1>
<p class="topmenu">
	<a href="javascript:newGame();">New Game</a>&nbsp;&nbsp;&nbsp;
	<a href="javascript:joinGame();">Join Game</a>&nbsp;&nbsp;&nbsp;
	<a href="javascript:leaveGame();">Leave Game</a>&nbsp;&nbsp;&nbsp;
	<a href="javascript:endGame();">End For All</a>&nbsp;&nbsp;&nbsp;
	<a href="javascript:rules();">How To Play</a>&nbsp;&nbsp;&nbsp;
</p>
<h3>Players</h3>
<div class="scoresview" id="scores">No other players yet.</div>
<!-- <h3>Time</h3> -->
<div class="timerview" id="timer"></div>
<h3>Access Code</h3>
<div class="acodeview" id="acode">Haven't joined a game.</div>
<hr />
<div class="gameview" id="game"></div>
<hr />
<p><h5><a href='https://docs.google.com/forms/d/1bXCNVe-bNdAvFdBKE_4MAGOswQSVLcg2ziAbXxrBRSw/edit'>Add Books</a></h5></p>
<p><h5>Game code is (C) 2020 Dan Ratner, All Rights Reserved. No personal data is collected by this app.</h5></p>
</body>
</html>